<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHECKICE - D√©couvrez les patinoires de France</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!--<script type="module" src="add-rinks.js"></script>--> 
    <script type="module" src="firebase.js"></script>
    <link rel="stylesheet" href="main.css">
    <!-- üé´ SYST√àME DE TICKETS - INT√âGRATION MINIMALE -->
    <link rel="stylesheet" href="ticket-styles.css">
    <script type="module" src="ticket-system.js"></script>
    <!-- Dans la section <head> -->
    <script type="module" src="friends-system.js"></script>
    <script type="module" src="friends-ui.js"></script>
    <!-- Dans la section head, apr√®s friends-chat.js -->
    <script type="module" src="event-channels.js"></script>
    <!-- Ajouter cette ligne dans le <head> apr√®s les autres scripts -->
    <script type="module" src="friends-chat.js"></script>
    <!-- Ajouter AVANT main.js -->
    <script type="module" src="state-manager.js"></script>  
    <script type="module" src="firebase-manager.js"></script>
    <script type="module" src="modal-manager.js"></script>
    <script type="module" src="main.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
    <script type="module" src="app.js"></script>
    <script type="module" src="map.js"></script>
    <script type="module">
    import { initializeMap } from './map.js';
    
    
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            initializeMap();
        }, 1000);
    });
    </script>
</head>
<body class="min-h-screen">
    <script type="module">
      import { auth } from "./firebase.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = "login.html";
        }
      });
    </script>
    
    <div class="container mx-auto px-4 py-6 max-w-5xl">
        <!-- ‚ú® HEADER R√âORGANIS√â -->
        <header class="header-container">
            <!-- Logo CHECKICE -->
            <div class="logo-section">
                <div class="w-12 h-12 ice-gradient rounded-2xl flex items-center justify-center mr-3 ice-shadow">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                </div>
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-cyan-500 font-extrabold text-3xl">CHECKICE</span>
            </div>
            <!-- conteneur pour les boutons dynamiques -->
<div id="dynamic-header-buttons" class="header-buttons"></div>

            <!-- Boutons du header dans l'ordre demand√© -->
            <div class="header-buttons-group">
                <!-- ‚úÖ 1. Bouton de niveau MODIFI√â -->
                <div class="level-progress-button-compact">
                    <!-- Logo + Nom du niveau (gauche) -->
                    <div class="level-info">
                        <span class="level-emoji">ü•∂</span>
                        <span class="level-name">D√©butant sur glace</span>
                    </div>
                    
                    <!-- Barre + Score (droite) -->
                    <div class="progress-container-compact">
                        <!-- Barre de progression r√©duite -->
                        <div class="progress-bar-container-compact">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                        
                        <!-- Score centr√© en dessous -->
                        <span class="progress-text-centered">0/100</span>
                    </div>
                </div>

                <!-- ‚úÖ 2. Espace pour les boutons dynamiques (ajout√©s par JS) -->
                <div id="dynamic-buttons-container" class="dynamic-buttons">
                    <!-- Les boutons "Mes Patinoires" et "Mes D√©placements" seront ajout√©s ici par JS -->
                </div>

                <!-- ‚úÖ 3. Bouton notifications -->
                <div class="relative">
                    <button id="notification-button" class="header-btn notification-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        <span class="notification-badge">5</span>
                    </button>
                </div>

                <!-- ‚úÖ 4. Bouton profil -->
                <div class="relative">
                    <button id="profile-button" class="header-btn profile-btn">
                        JD
                    </button>

                    <!-- Menu profil -->
                    <div id="profile-menu" class="absolute right-0 mt-2 w-64 bg-white shadow-lg rounded-xl p-4 hidden" style="z-index: 10000;">
                        <div class="mb-2 text-center">
                            <div id="profile-avatar" class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-500 to-cyan-400 flex items-center justify-center mx-auto mb-2 text-white font-bold text-lg">JD</div>
                            <input type="text" id="profile-username" class="w-full p-2 border rounded mb-1 text-center" placeholder="Pseudo">
                            <div id="profile-email" class="text-sm text-gray-600">user@example.com</div>
                        </div>
                        <hr class="my-2">
                        <div>
                            <button id="my-rinks-btn" class="w-full text-left p-2 hover:bg-gray-100 rounded">Mes patinoires</button>
                            <button id="my-moves-btn" class="w-full text-left p-2 hover:bg-gray-100 rounded">Mes d√©placements</button>
                            <button id="logout-btn" class="w-full text-left p-2 hover:bg-red-100 rounded text-red-500 mt-2">Se d√©connecter</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- SCRIPT POUR LE BOUTON PROFIL -->
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const profileButton = document.getElementById('profile-button');
            const profileMenu = document.getElementById('profile-menu');

            profileButton.addEventListener('click', function(e) {
                e.stopPropagation();
                profileMenu.classList.toggle('hidden');
            });

            document.addEventListener('click', function(e) {
                if (!profileMenu.contains(e.target) && !profileButton.contains(e.target)) {
                    profileMenu.classList.add('hidden');
                }
            });
        });
        </script>

        <!-- Barre de recherche am√©lior√©e -->
        <div class="relative mb-8">
            <div class="relative">
                <input type="text" id="search-input" placeholder="Rechercher des patinoires, √©v√©nements, amis..." class="search-bar w-full py-4 px-14 rounded-2xl ice-shadow border-0 focus:outline-none text-gray-700 text-lg" autocomplete="off">
                <div class="absolute left-5 top-1/2 transform -translate-y-1/2 text-blue-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <div class="absolute right-5 top-1/2 transform -translate-y-1/2">
                    <button class="text-blue-500 hover:text-blue-600 transition-colors" onclick="toggleSearchFilters()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                        </svg>
                    </button>
                </div>
                
                <div id="search-suggestions" class="search-suggestions">
                    <!-- Les suggestions seront ajout√©es dynamiquement -->
                </div>
            </div>
        </div>

        <!-- Onglets redesign√©s -->
        <div class="flex justify-between mb-8 rounded-2xl ice-shadow frost-effect p-2">
            <button class="tab-button flex-1 py-4 px-3 rounded-xl flex items-center justify-center text-blue-600 font-medium" data-tab="events">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <span class="hidden sm:inline">√âv√©nements</span>
            </button>
            <button class="tab-button tab-active flex-1 py-4 px-3 rounded-xl flex items-center justify-center font-medium" data-tab="map">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                </svg>
                <span class="hidden sm:inline">Carte</span>
            </button>
            <button class="tab-button flex-1 py-4 px-3 rounded-xl flex items-center justify-center text-blue-600 font-medium" data-tab="check">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                <span class="hidden sm:inline">Checklist</span>
            </button>
            <button class="tab-button flex-1 py-4 px-3 rounded-xl flex items-center justify-center text-blue-600 font-medium" data-tab="friends">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <span class="hidden sm:inline">Social</span>
            </button>
        </div>

        <!-- Contenu principal -->
        <div class="mb-8">
            <!-- Section Carte -->
            <div id="map-section" class="content-section active">
                <div class="h-96 mb-8 rounded-2xl overflow-hidden ice-shadow-lg">
                    <div id="map"></div>
                </div>

                

                <!-- Patinoires √† proximit√© -->
                <div class="frost-effect rounded-2xl p-6 mb-8 ice-shadow">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Patinoires √† proximit√©</h2>
                        <button class="ice-button-secondary px-4 py-2 rounded-xl font-medium">
                            Voir tout
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="rink-card rounded-xl p-4 card-hover cursor-pointer ice-shadow" onclick="openRinkDetails('bercy')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="w-12 h-12 rounded-xl ice-gradient flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </div>
                                <span class="text-xs font-semibold bg-green-100 text-green-600 py-1 px-2 rounded-full">Ouvert</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Patinoire de Bercy</h3>
                            <p class="text-sm text-gray-600 mb-3">Paris ‚Ä¢ 2.5 km</p>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center text-xs text-gray-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    Ferme √† 22h
                                </div>
                                <div class="flex items-center">
                                    <div class="flex text-yellow-400">
                                        ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                                    </div>
                                    <span class="text-xs text-gray-500 ml-1">4.8</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="rink-card rounded-xl p-4 card-hover cursor-pointer ice-shadow" onclick="openRinkDetails('lyon')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="w-12 h-12 rounded-xl ice-gradient flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </div>
                                <span class="text-xs font-semibold bg-green-100 text-green-600 py-1 px-2 rounded-full">Ouvert</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Patinoire Charlemagne</h3>
                            <p class="text-sm text-gray-600 mb-3">Lyon ‚Ä¢ 5.8 km</p>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center text-xs text-gray-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    Ferme √† 21h30
                                </div>
                                <div class="flex items-center">
                                    <div class="flex text-yellow-400">
                                        ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ
                                    </div>
                                    <span class="text-xs text-gray-500 ml-1">4.2</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="rink-card rounded-xl p-4 card-hover cursor-pointer ice-shadow" onclick="openRinkDetails('marseille')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="w-12 h-12 rounded-xl ice-gradient flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </div>
                                <span class="text-xs font-semibold bg-red-100 text-red-600 py-1 px-2 rounded-full">Ferm√©</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Palais Omnisports</h3>
                            <p class="text-sm text-gray-600 mb-3">Marseille ‚Ä¢ 8.2 km</p>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center text-xs text-gray-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    Ouvre √† 9h
                                </div>
                                <div class="flex items-center">
                                    <div class="flex text-yellow-400">
                                        ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                                    </div>
                                    <span class="text-xs text-gray-500 ml-1">4.6</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section √âv√©nements -->
            <div id="events-section" class="content-section">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">√âv√©nements √† venir</h2>
                    <button class="ice-button px-6 py-3 rounded-xl text-white font-semibold flex items-center" onclick="openCreateEventModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Cr√©er
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- √âv√©nement 1 -->
                    <div class="frost-effect rounded-2xl p-6 card-hover ice-shadow">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-16 h-16 rounded-2xl event-type-competition flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 15.546c-.523 0-1.046.151-1.5.454a2.704 2.704 0 01-3 0 2.704 2.704 0 00-3 0 2.704 2.704 0 01-3 0 2.704 2.704 0 00-3 0 2.704 2.704 0 01-3 0 2.701 2.701 0 00-1.5-.454M9 6v2m3-2v2m3-2v2M9 3h.01M12 3h.01M15 3h.01M21 21v-7a2 2 0 00-2-2H5a2 2 0 00-2 2v7h18zm-3-9v-2a2 2 0 00-2-2H8a2 2 0 00-2 2v2h12z" />
                                </svg>
                            </div>
                            <span class="text-xs font-semibold bg-orange-100 text-orange-600 py-1 px-3 rounded-full">Comp√©tition</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Championnat de France</h3>
                        <p class="text-gray-600 mb-4">15-16 Janvier 2023</p>
                        <div class="flex items-center mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <span class="text-sm text-gray-600">Patinoire de Bercy, Paris</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <span class="text-sm font-bold bg-blue-100 text-blue-600 py-2 px-3 rounded-lg">+50 points</span>
                                <span class="text-xs text-gray-500 ml-2">127 participants</span>
                            </div>
                            <button class="ice-button py-2 px-4 rounded-lg text-white font-semibold">Participer</button>
                        </div>
                    </div>
                    
                    <!-- √âv√©nement 2 -->
                    <div class="frost-effect rounded-2xl p-6 card-hover ice-shadow">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-16 h-16 rounded-2xl event-type-show flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                                </svg>
                            </div>
                            <span class="text-xs font-semibold bg-purple-100 text-purple-600 py-1 px-3 rounded-full">Spectacle</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Spectacle sur Glace</h3>
                        <p class="text-gray-600 mb-4">22 Janvier 2023, 20:00</p>
                        <div class="flex items-center mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <span class="text-sm text-gray-600">Patinoire Charlemagne, Lyon</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <span class="text-sm font-bold bg-blue-100 text-blue-600 py-2 px-3 rounded-lg">+30 points</span>
                                <span class="text-xs text-gray-500 ml-2">89 participants</span>
                            </div>
                            <button class="ice-button py-2 px-4 rounded-lg text-white font-semibold">Participer</button>
                        </div>
                    </div>
                    
                    <!-- √âv√©nement 3 -->
                    <div class="frost-effect rounded-2xl p-6 card-hover ice-shadow">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-16 h-16 rounded-2xl event-type-lesson flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                            </div>
                            <span class="text-xs font-semibold bg-green-100 text-green-600 py-1 px-3 rounded-full">Cours</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Cours de Patinage</h3>
                        <p class="text-gray-600 mb-4">Tous les samedis, 10:00</p>
                        <div class="flex items-center mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <span class="text-sm text-gray-600">Palais Omnisports, Marseille</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <span class="text-sm font-bold bg-blue-100 text-blue-600 py-2 px-3 rounded-lg">+20 points</span>
                                <span class="text-xs text-gray-500 ml-2">15 participants</span>
                            </div>
                            <button class="ice-button py-2 px-4 rounded-lg text-white font-semibold">Participer</button>
                        </div>
                    </div>
                    
                    <!-- √âv√©nement 4 -->
                    <div class="frost-effect rounded-2xl p-6 card-hover ice-shadow">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-16 h-16 rounded-2xl event-type-tournament flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                            </div>
                            <div class="flex items-center">
                                <span class="text-xs font-semibold bg-green-100 text-green-600 py-1 px-2 rounded-full mr-2">Nouveau</span>
                                <span class="text-xs font-semibold bg-red-100 text-red-600 py-1 px-3 rounded-full">Tournoi</span>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Tournoi de Hockey Amateur</h3>
                        <p class="text-gray-600 mb-4">5 F√©vrier 2023, 09:00</p>
                        <div class="flex items-center mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <span class="text-sm text-gray-600">Patinoire de Grenoble</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <span class="text-sm font-bold bg-blue-100 text-blue-600 py-2 px-3 rounded-lg">+75 points</span>
                                <span class="text-xs text-gray-500 ml-2">32 participants</span>
                            </div>
                            <button class="ice-button py-2 px-4 rounded-lg text-white font-semibold">Participer</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚úÖ REMPLAC√â: Structure minimaliste pour la checklist dynamique -->
            <div id="check-section" class="content-section">
                <div class="space-y-4">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">
                        üèí Patinoires √† d√©couvrir
                    </h2>
                    <!-- Le contenu dynamique sera ajout√© ici par JavaScript -->
                </div>
            </div>


                    <!-- ‚úÖ Section Amis - NOUVEAU SYST√àME -->
        <div id="friends-section" class="content-section">
        <!-- üîç Barre de recherche -->
        <div class="flex items-center justify-between mb-6 scroll-animate">
            <h2 class="text-2xl font-bold text-gray-800 title-animate">üë• R√©seau Social CHECKICE</h2>
            <div class="flex items-center space-x-3">
            <span id="friend-count" class="bg-blue-100 text-blue-600 text-sm font-bold px-3 py-1 rounded-full">0 amis</span>
            <span id="online-count" class="bg-green-100 text-green-600 text-sm font-bold px-3 py-1 rounded-full">0 en ligne</span>
            </div>
        </div>

        <!-- ‚úÖ Recherche d'amis -->
        <div class="friends-search-container mb-6 scroll-animate-left">
            <div class="relative">
            <input 
                type="text" 
                id="friend-search-input"
                placeholder="üîç Rechercher par pseudo ou email..."
                class="search-bar w-full py-4 px-14 rounded-2xl ice-shadow border-0 focus:outline-none text-gray-700 text-lg"
            >
            <div class="absolute left-5 top-1/2 transform -translate-y-1/2 text-blue-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
            </div>
            </div>
            <div id="search-results" class="search-results frost-effect rounded-2xl mt-2 hidden ice-shadow"></div>
        </div>

        <!-- ‚úÖ Demandes d'amis -->
        <div class="frost-effect rounded-2xl p-6 mb-8 ice-shadow scroll-animate-scale">
            <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-gray-800">üì© Demandes d'amis</h3>
            <span id="requests-count" class="bg-red-100 text-red-600 text-xs font-bold px-3 py-1 rounded-full hidden">0</span>
            </div>
            <div id="friend-requests-container">
            <div class="text-center py-6">
                <div class="text-4xl mb-2">üì≠</div>
                <p class="text-gray-500 italic">Chargement des demandes...</p>
            </div>
            </div>
        </div>
        
        <!-- ‚úÖ Classement des amis -->
        <div class="frost-effect rounded-2xl p-6 mb-8 ice-shadow scroll-animate">
            <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-gray-800">üèÜ Classement de mes amis</h3>
            <button class="ice-button-secondary px-3 py-1 rounded-lg text-sm" onclick="refreshFriends()">
                üîÑ Actualiser
            </button>
            </div>
            <div id="friends-list-container">
            <div class="text-center py-8">
                <div class="text-6xl mb-4">‚è≥</div>
                <p class="text-gray-500 text-lg">Chargement du classement...</p>
                <p class="text-gray-400 text-sm mt-2">Patientez pendant que nous r√©cup√©rons vos amis...</p>
            </div>
            </div>
        </div>
        </div>


        <!-- Panneau de notifications -->
        <div id="notification-panel" class="notification-panel frost-effect rounded-2xl p-4 ice-shadow">
            <h3 class="font-bold text-gray-800 mb-4">Notifications</h3>
            <div class="space-y-3 scrollbar-hide">
                <div class="notification-item unread rounded-xl p-3 cursor-pointer">
                    <div class="flex items-start">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-r from-green-500 to-emerald-400 flex items-center justify-center mr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-semibold text-gray-800">D√©fi compl√©t√© !</p>
                            <p class="text-xs text-gray-600">Vous avez gagn√© 40 points</p>
                            <p class="text-xs text-gray-400 mt-1">Il y a 5 minutes</p>
                        </div>
                    </div>
                </div>
                
                <div class="notification-item unread rounded-xl p-3 cursor-pointer">
                    <div class="flex items-start">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-r from-blue-500 to-cyan-400 flex items-center justify-center mr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-semibold text-gray-800">Nouvelle demande d'ami</p>
                            <p class="text-xs text-gray-600">Claire Leroy souhaite vous ajouter</p>
                            <p class="text-xs text-gray-400 mt-1">Il y a 1 heure</p>
                        </div>
                    </div>
                </div>
                
                <div class="notification-item rounded-xl p-3 cursor-pointer">
                    <div class="flex items-start">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-r from-purple-500 to-pink-400 flex items-center justify-center mr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-semibold text-gray-800">Nouvel √©v√©nement</p>
                            <p class="text-xs text-gray-600">Tournoi de Hockey Amateur √† Grenoble</p>
                            <p class="text-xs text-gray-400 mt-1">Il y a 3 heures</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bouton d'action flottant -->
        <div class="floating-action">
            <button class="ice-button w-16 h-16 rounded-full text-white ice-shadow-lg" onclick="openQuickActionModal()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Modales (simplifi√©es pour l'exemple) -->
    <div id="rink-modal" class="modal">
        <div class="modal-content frost-effect p-6">
            <h3 class="text-xl font-bold mb-4">D√©tails de la patinoire</h3>
            <p>Informations d√©taill√©es sur la patinoire s√©lectionn√©e...</p>
            <button class="ice-button mt-4 px-4 py-2 rounded-lg text-white" onclick="closeModal('rink-modal')">Fermer</button>
        </div>
    </div>

    <!-- Modal Connexion -->
<div id="login-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-8 w-96">
    <h2 class="text-2xl font-bold mb-4">Connexion</h2>
    <input id="login-email" type="email" placeholder="Email" class="border rounded w-full mb-3 p-2">
    <input id="login-password" type="password" placeholder="Mot de passe" class="border rounded w-full mb-3 p-2">
    <button id="login-button" class="bg-blue-500 text-white rounded w-full py-2 mb-2">Se connecter</button>
    <button id="register-button" class="bg-green-500 text-white rounded w-full py-2">Cr√©er un compte</button>
    <button onclick="closeModal('login-modal')" class="mt-3 text-gray-500">Fermer</button>
  </div>
</div>


    <script>
        // Variables globales
        let map;
        let currentPoints = 1247;
        let allRinks = [];
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {

            initializeTabs();
            initializeNotifications();
            initializeSearch();
            updatePointsDisplay();
        });
        
        // Initialisation de la carte
        function initializeMap() {
            map = L.map('map').setView([46.603354, 1.888334], 6);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Base de donn√©es compl√®te des patinoires de France
            const rinks = [
                // √éle-de-France
                {lat: 48.8566, lng: 2.3522, name: 'Patinoire de Bercy', city: 'Paris', status: 'open', rating: 4.8, price: '12‚Ç¨', hours: '10h-22h', surface: 'Olympique', activities: ['Hockey', 'Patinage libre', 'Cours'], phone: '01 44 68 44 68'},
                {lat: 48.8606, lng: 2.3376, name: 'Patinoire Charlemagne', city: 'Paris', status: 'open', rating: 4.2, price: '10‚Ç¨', hours: '9h-21h30', surface: 'Standard', activities: ['Patinage libre', 'Cours'], phone: '01 42 77 17 17'},
                {lat: 48.8496, lng: 2.3712, name: 'Patinoire Pailleron', city: 'Paris', status: 'closed', rating: 4.1, price: '9‚Ç¨', hours: 'Ferm√©', surface: 'Standard', activities: ['Patinage libre'], phone: '01 40 40 27 70'},
                {lat: 48.9014, lng: 2.3708, name: 'Patinoire de Neuilly-sur-Seine', city: 'Neuilly-sur-Seine', status: 'open', rating: 4.5, price: '11‚Ç¨', hours: '10h-22h', surface: 'Standard', activities: ['Hockey', 'Patinage libre'], phone: '01 47 45 70 37'},
                {lat: 48.7589, lng: 2.3468, name: 'Patinoire de Boulogne-Billancourt', city: 'Boulogne-Billancourt', status: 'open', rating: 4.3, price: '10‚Ç¨', hours: '9h30-22h', surface: 'Standard', activities: ['Hockey', 'Patinage libre', 'Cours'], phone: '01 55 95 64 40'},
                
                // Lyon et r√©gion
                {lat: 45.7640, lng: 4.8357, name: 'Patinoire Charlemagne', city: 'Lyon', status: 'open', rating: 4.6, price: '8‚Ç¨', hours: '10h-22h', surface: 'Olympique', activities: ['Hockey', 'Patinage libre', 'Spectacles'], phone: '04 78 89 47 49'},
                {lat: 45.7489, lng: 4.8467, name: 'Patinoire du Baraban', city: 'Lyon', status: 'open', rating: 4.0, price: '7‚Ç¨', hours: '14h-18h', surface: 'Standard', activities: ['Patinage libre', 'Cours'], phone: '04 78 74 50 38'},
                {lat: 45.6870, lng: 4.8357, name: 'Patinoire de Villeurbanne', city: 'Villeurbanne', status: 'open', rating: 4.2, price: '8‚Ç¨', hours: '10h-21h', surface: 'Standard', activities: ['Hockey', 'Patinage libre'], phone: '04 72 13 83 50'},
                
                // Marseille et PACA
                {lat: 43.2965, lng: 5.3698, name: 'Palais Omnisports Marseille Grand-Est', city: 'Marseille', status: 'open', rating: 4.4, price: '9‚Ç¨', hours: '10h-22h', surface: 'Olympique', activities: ['Hockey', 'Patinage libre', 'Spectacles'], phone: '04 91 12 21 12'},
                {lat: 43.7102, lng: 7.2620, name: 'Patinoire Jean Bouin', city: 'Nice', status: 'open', rating: 4.1, price: '10‚Ç¨', hours: '10h-21h', surface: 'Standard', activities: ['Patinage libre', 'Cours'], phone: '04 97 13 50 00'},
                {lat: 43.5297, lng: 5.4474, name: 'Patinoire d\'Aix-en-Provence', city: 'Aix-en-Provence', status: 'open', rating: 3.9, price: '8‚Ç¨', hours: '14h-18h', surface: 'Standard', activities: ['Patinage libre'], phone: '04 42 91 98 15'},
                
                // Toulouse et Occitanie
                {lat: 43.6047, lng: 1.4442, name: 'Patinoire Alex Jany', city: 'Toulouse', status: 'open', rating: 4.3, price: '8‚Ç¨', hours: '10h-22h', surface: 'Standard', activities: ['Hockey', 'Patinage libre', 'Cours'], phone: '05 34 45 58 40'},
                {lat: 43.8374, lng: 4.3601, name: 'Patinoire de N√Æmes', city: 'N√Æmes', status: 'open', rating: 4.0, price: '7‚Ç¨', hours: '14h-19h', surface: 'Standard', activities: ['Patinage libre', 'Cours'], phone: '04 66 38 31 00'},
                {lat: 43.6108, lng: 3.8767, name: 'Patinoire de Montpellier', city: 'Montpellier', status: 'open', rating: 4.2, price: '8‚Ç¨', hours: '10h-21h', surface: 'Standard', activities: ['Hockey', 'Patinage libre'], phone: '04 99 58 17 17'},
                
                // Bordeaux et Nouvelle-Aquitaine
                {lat: 44.8378, lng: -0.5792, name: 'Patinoire M√©riadeck', city: 'Bordeaux', status: 'open', rating: 4.5, price: '9‚Ç¨', hours: '10h-22h', surface: 'Olympique', activities: ['Hockey', 'Patinage libre', 'Spectacles'], phone: '05 56 24 58 58'},
                {lat: 45.8336, lng: 1.2611, name: 'Patinoire de Limoges', city: 'Limoges', status: 'open', rating: 3.8, price: '7‚Ç¨', hours: '14h-18h', surface: 'Standard', activities: ['Patinage libre'], phone: '05 55 45 62 62'},
                {lat: 43.4832, lng: -1.5586, name: 'Patinoire de Biarritz', city: 'Biarritz', status: 'open', rating: 4.1, price: '10‚Ç¨', hours: '10h-20h', surface: 'Standard', activities: ['Patinage libre', 'Cours'], phone: '05 59 01 64 64'},
                
                // Lille et Hauts-de-France
                {lat: 50.6292, lng: 3.0573, name: 'Patinoire Serge Charles', city: 'Lille', status: 'open', rating: 4.4, price: '8‚Ç¨', hours: '10h-22h', surface: 'Olympique', activities: ['Hockey', 'Patinage libre', 'Spectacles'], phone: '03 20 21 21 21'},
                {lat: 49.4944, lng: 0.1079, name: 'Patinoire du Havre', city: 'Le Havre', status: 'open', rating: 4.0, price: '8‚Ç¨', hours: '14h-19h', surface: 'Standard', activities: ['Patinage libre', 'Cours'], phone: '02 35 19 45 45'},
                {lat: 49.2628, lng: 4.0347, name: 'Patinoire de Reims', city: 'Reims', status: 'open', rating: 4.2, price: '7‚Ç¨', hours: '10h-21h', surface: 'Standard', activities: ['Hockey', 'Patinage libre'], phone: '03 26 35 52 52'},
                
                // Strasbourg et Grand Est
                {lat: 48.5734, lng: 7.7521, name: 'Patinoire Iceberg', city: 'Strasbourg', status: 'open', rating: 4.7, price: '9‚Ç¨', hours: '10h-22h', surface: 'Olympique', activities: ['Hockey', 'Patinage libre', 'Spectacles'], phone: '03 88 40 15 00'},
                {lat: 49.1193, lng: 6.1757, name: 'Patinoire de Metz', city: 'Metz', status: 'open', rating: 4.1, price: '8‚Ç¨', hours: '14h-20h', surface: 'Standard', activities: ['Patinage libre', 'Cours'], phone: '03 87 55 66 77'},
                {lat: 47.3220, lng: 5.0415, name: 'Patinoire de Dijon', city: 'Dijon', status: 'open', rating: 4.0, price: '7‚Ç¨', hours: '10h-19h', surface: 'Standard', activities: ['Hockey', 'Patinage libre'], phone: '03 80 48 12 12'},
                
                // Nantes et Pays de la Loire
                {lat: 47.2184, lng: -1.5536, name: 'Patinoire du Petit Port', city: 'Nantes', status: 'open', rating: 4.3, price: '8‚Ç¨', hours: '10h-21h', surface: 'Standard', activities: ['Hockey', 'Patinage libre', 'Cours'], phone: '02 51 84 94 51'},
                {lat: 47.4784, lng: -0.5632, name: 'Patinoire d\'Angers', city: 'Angers', status: 'open', rating: 3.9, price: '7‚Ç¨', hours: '14h-18h', surface: 'Standard', activities: ['Patinage libre'], phone: '02 41 05 40 40'},
                {lat: 48.0833, lng: 0.7667, name: 'Patinoire du Mans', city: 'Le Mans', status: 'open', rating: 4.1, price: '8‚Ç¨', hours: '10h-20h', surface: 'Standard', activities: ['Hockey', 'Patinage libre'], phone: '02 43 47 38 38'},
                
                // Rennes et Bretagne
                {lat: 48.1173, lng: -1.6778, name: 'Patinoire La Gayeulles', city: 'Rennes', status: 'open', rating: 4.2, price: '8‚Ç¨', hours: '10h-21h', surface: 'Standard', activities: ['Hockey', 'Patinage libre', 'Cours'], phone: '02 23 62 17 40'},
                {lat: 48.3904, lng: -4.4861, name: 'Patinoire de Brest', city: 'Brest', status: 'open', rating: 3.8, price: '7‚Ç¨', hours: '14h-19h', surface: 'Standard', activities: ['Patinage libre'], phone: '02 98 00 80 80'},
                
                // Alpes et montagne
                {lat: 45.1885, lng: 5.7245, name: 'Patinoire Polesud', city: 'Grenoble', status: 'open', rating: 4.6, price: '9‚Ç¨', hours: '10h-22h', surface: 'Olympique', activities: ['Hockey', 'Patinage libre', 'Spectacles'], phone: '04 76 39 45 45'},
                {lat: 45.8992, lng: 6.1294, name: 'Patinoire Richard Bozon', city: 'Chamonix', status: 'open', rating: 4.8, price: '12‚Ç¨', hours: '9h-22h', surface: 'Olympique', activities: ['Hockey', 'Patinage libre', 'Curling'], phone: '04 50 53 12 36'},
                {lat: 45.5017, lng: 6.6322, name: 'Patinoire de Courchevel', city: 'Courchevel', status: 'open', rating: 4.7, price: '15‚Ç¨', hours: '10h-20h', surface: 'Standard', activities: ['Patinage libre', 'Cours'], phone: '04 79 08 01 29'},
                {lat: 46.0207, lng: 6.1416, name: 'Patinoire d\'Annecy', city: 'Annecy', status: 'open', rating: 4.4, price: '9‚Ç¨', hours: '10h-21h', surface: 'Standard', activities: ['Hockey', 'Patinage libre'], phone: '04 50 33 44 00'},
                
                // Autres villes importantes
                {lat: 47.0584, lng: 2.3988, name: 'Patinoire de Bourges', city: 'Bourges', status: 'open', rating: 3.9, price: '7‚Ç¨', hours: '14h-18h', surface: 'Standard', activities: ['Patinage libre'], phone: '02 48 57 81 90'},
                {lat: 49.4431, lng: 1.0993, name: 'Patinoire de Rouen', city: 'Rouen', status: 'open', rating: 4.1, price: '8‚Ç¨', hours: '10h-20h', surface: 'Standard', activities: ['Hockey', 'Patinage libre'], phone: '02 35 03 29 29'},
                {lat: 45.0703, lng: 3.8856, name: 'Patinoire du Puy-en-Velay', city: 'Le Puy-en-Velay', status: 'closed', rating: 3.7, price: '6‚Ç¨', hours: 'Ferm√©', surface: 'Standard', activities: ['Patinage libre'], phone: '04 71 04 04 04'}
            ];
            
            // Stocker les patinoires pour la recherche
            allRinks = rinks;
            
            // Cr√©ation des marqueurs avec popups d√©taill√©es
            rinks.forEach(rink => {
                const color = rink.status === 'open' ? '#10b981' : '#ef4444';
                const statusText = rink.status === 'open' ? 'Ouvert' : 'Ferm√©';
                const statusClass = rink.status === 'open' ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100';
                
                // Cr√©ation du contenu HTML du popup
                const popupContent = `
                    <div class="p-4 min-w-80">
                        <div class="flex items-start justify-between mb-3">
                            <h3 class="text-lg font-bold text-gray-800 pr-2">${rink.name}</h3>
                            <span class="text-xs font-semibold ${statusClass} py-1 px-2 rounded-full whitespace-nowrap">${statusText}</span>
                        </div>
                        
                        <div class="space-y-2 mb-4">
                            <div class="flex items-center text-sm text-gray-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                ${rink.city}
                            </div>
                            
                            <div class="flex items-center text-sm text-gray-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                ${rink.hours}
                            </div>
                            
                            <div class="flex items-center text-sm text-gray-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                ${rink.price}
                            </div>
                            
                            <div class="flex items-center text-sm text-gray-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                </svg>
                                ${rink.phone}
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <div class="flex text-yellow-400 text-sm mr-2">
                                    ${'‚òÖ'.repeat(Math.floor(rink.rating))}${'‚òÜ'.repeat(5 - Math.floor(rink.rating))}
                                </div>
                                <span class="text-sm text-gray-600">${rink.rating}/5</span>
                            </div>
                            <span class="text-xs font-semibold bg-blue-100 text-blue-600 py-1 px-2 rounded-full">${rink.surface}</span>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-sm font-semibold text-gray-700 mb-2">Activit√©s disponibles:</p>
                            <div class="flex flex-wrap gap-1">
                                ${rink.activities.map(activity => 
                                    `<span class="text-xs bg-gray-100 text-gray-700 py-1 px-2 rounded-full">${activity}</span>`
                                ).join('')}
                            </div>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="addToChecklist('${rink.name}', '${rink.city}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-2 px-3 rounded-lg transition-colors">
                                Ajouter √† ma liste
                            </button>
                            <button onclick="getDirections(${rink.lat}, ${rink.lng})" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white text-sm font-semibold py-2 px-3 rounded-lg transition-colors">
                                Itin√©raire
                            </button>
                        </div>
                    </div>
                `;
                
                const marker = L.circleMarker([rink.lat, rink.lng], {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.8,
                    radius: 8,
                    weight: 2
                }).addTo(map);
                
                marker.bindPopup(popupContent, {
                    maxWidth: 350,
                    className: 'custom-popup'
                });
                
                // Animation au survol
                marker.on('mouseover', function() {
                    this.setRadius(12);
                    this.setStyle({weight: 3});
                });
                
                marker.on('mouseout', function() {
                    this.setRadius(8);
                    this.setStyle({weight: 2});
                });
            });
        }
        
        // Gestion des onglets
        function initializeTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const contentSections = document.querySelectorAll('.content-section');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.getAttribute('data-tab');
                    
                    // Mise √† jour des onglets
                    tabButtons.forEach(btn => btn.classList.remove('tab-active'));
                    button.classList.add('tab-active');
                    
                    // Mise √† jour du contenu
                    contentSections.forEach(section => {
                        section.classList.remove('active');
                        if (section.id === targetTab + '-section') {
                            section.classList.add('active');
                        }
                    });
                    
                    // Redimensionner la carte si n√©cessaire
                    if (targetTab === 'map') {
                        setTimeout(() => {
                            if (map) map.invalidateSize();
                        }, 100);
                    }
                });
            });
        }
        
        // Gestion des notifications
        function initializeNotifications() {
            const notificationButton = document.getElementById('notification-button');
            const notificationPanel = document.getElementById('notification-panel');
            
            notificationButton.addEventListener('click', (e) => {
                e.stopPropagation();
                notificationPanel.classList.toggle('active');
            });
            
            document.addEventListener('click', () => {
                notificationPanel.classList.remove('active');
            });
            
            notificationPanel.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }
        
        // Gestion des √©l√©ments de checklist
        function toggleChecklistItem(element) {
            const item = element.closest('.checklist-item');
            const points = parseInt(item.getAttribute('data-points'));
            
            if (item.classList.contains('checked')) {
                // D√©cocher
                item.classList.remove('checked');
                element.innerHTML = '';
                element.classList.remove('ice-gradient');
                element.classList.add('border-2', 'border-blue-300');
                currentPoints -= points;
                updateCompletedCount(-1);
            } else {
                // Cocher
                item.classList.add('checked');
                element.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                `;
                element.classList.remove('border-2', 'border-blue-300');
                element.classList.add('ice-gradient');
                currentPoints += points;
                updateCompletedCount(1);
                
                // Animation de points
                showPointsAnimation(points);
            }
            
            updatePointsDisplay();
        }
        
        // Mise √† jour de l'affichage des points
        function updatePointsDisplay() {
            const pointsCounter = document.getElementById('points-counter');
            if (pointsCounter) {
                pointsCounter.textContent = currentPoints.toLocaleString();
            }
        }
        
        // Mise √† jour du compteur de t√¢ches compl√©t√©es
        function updateCompletedCount(change) {
            const completedElement = document.getElementById('completed-count');
            if (completedElement) {
                const current = parseInt(completedElement.textContent);
                completedElement.textContent = current + change;
                
                // Mise √† jour de la barre de progression
                const total = parseInt(document.getElementById('total-count').textContent);
                const percentage = ((current + change) / total) * 100;
                const progressBar = document.querySelector('.progress-bar');
                if (progressBar) {
                    progressBar.style.width = percentage + '%';
                }
            }
        }
        
        // Animation des points gagn√©s
        function showPointsAnimation(points) {
            const animation = document.createElement('div');
            animation.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl font-bold text-blue-600 z-50 pointer-events-none';
            animation.textContent = `+${points}`;
            animation.style.animation = 'pointsAnimation 2s ease-out forwards';
            
            document.body.appendChild(animation);
            
            setTimeout(() => {
                document.body.removeChild(animation);
            }, 2000);
        }
        
        // Gestion des demandes d'amis
        function acceptFriendRequest(button) {
            const requestElement = button.closest('.friend-request');
            requestElement.style.animation = 'slideOut 0.3s ease-out forwards';
            setTimeout(() => {
                requestElement.remove();
            }, 300);
            
            // Notification de succ√®s
            showNotification('Demande d\'ami accept√©e !', 'success');
        }
        
        function rejectFriendRequest(button) {
            const requestElement = button.closest('.friend-request');
            requestElement.style.animation = 'slideOut 0.3s ease-out forwards';
            setTimeout(() => {
                requestElement.remove();
            }, 300);
        }
        
        
        function getDirections(lat, lng) {
            // Ouvrir Google Maps avec les directions
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            window.open(url, '_blank');
        }
        
        // Syst√®me de recherche intelligent
        function initializeSearch() {
            const searchInput = document.getElementById('search-input');
            const suggestionsContainer = document.getElementById('search-suggestions');
            
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase().trim();
                
                if (query.length < 2) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }
                
                const suggestions = searchRinks(query);
                displaySuggestions(suggestions, suggestionsContainer);
            });
            
            // Fermer les suggestions en cliquant ailleurs
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.relative')) {
                    suggestionsContainer.style.display = 'none';
                }
            });
        }
        
        function searchRinks(query) {
            return allRinks.filter(rink => {
                return rink.name.toLowerCase().includes(query) ||
                       rink.city.toLowerCase().includes(query) ||
                       rink.activities.some(activity => activity.toLowerCase().includes(query));
            }).slice(0, 8); // Limiter √† 8 r√©sultats
        }
        
        function displaySuggestions(suggestions, container) {
            if (suggestions.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.innerHTML = suggestions.map(rink => `
                <div class="search-suggestion" onclick="selectRink(${rink.lat}, ${rink.lng}, '${rink.name}')">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-xl ice-gradient flex items-center justify-center mr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">${rink.name}</h4>
                            <p class="text-sm text-gray-600">${rink.city} ‚Ä¢ ${rink.status === 'open' ? 'Ouvert' : 'Ferm√©'} ‚Ä¢ ${rink.rating}‚òÖ</p>
                        </div>
                        <div class="text-right">
                            <span class="text-sm font-bold text-blue-600">${rink.price}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.style.display = 'block';
        }
        
        function selectRink(lat, lng, name) {
            // Centrer la carte sur la patinoire s√©lectionn√©e
            map.setView([lat, lng], 15);
            
            // Fermer les suggestions
            document.getElementById('search-suggestions').style.display = 'none';
            document.getElementById('search-input').value = name;
            
            // Changer vers l'onglet carte
            const mapTab = document.querySelector('[data-tab="map"]');
            if (mapTab) {
                mapTab.click();
            }
            
            // Trouver et ouvrir le popup du marqueur
            setTimeout(() => {
                map.eachLayer(function(layer) {
                    if (layer.getLatLng && layer.getLatLng().lat === lat && layer.getLatLng().lng === lng) {
                        layer.openPopup();
                    }
                });
            }, 500);
        }
        
        function toggleSearchFilters() {
            showNotification('Filtres de recherche √† venir !', 'info');
        }
        
        // Fonctions modales
        function openRinkDetails(rinkId) {
            const modal = document.getElementById('rink-modal');
            modal.classList.add('active');
        }
        
        function openCreateEventModal() {
            showNotification('Fonctionnalit√© de cr√©ation d\'√©v√©nement √† venir !', 'info');
        }
        
        function openAddFriendModal() {
            showNotification('Fonctionnalit√© d\'ajout d\'ami √† venir !', 'info');
        }
        
        function openChatModal(friendName) {
            showNotification(`Chat avec ${friendName} √† venir !`, 'info');
        }
        
        function openQuickActionModal() {
            showNotification('Actions rapides √† venir !', 'info');
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');
        }
        
        // Syst√®me de notifications
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-xl text-white font-semibold z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            }`;
            notification.textContent = message;
            notification.style.animation = 'slideInRight 0.3s ease-out';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // Styles d'animation suppl√©mentaires
        const additionalStyles = `
            @keyframes pointsAnimation {
                0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
                50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
                100% { transform: translate(-50%, -50%) scale(1) translateY(-100px); opacity: 0; }
            }
            
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = additionalStyles;
        document.head.appendChild(styleSheet);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9797938ce30e9ef5',t:'MTc1NjkyNjkzMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
    <!-- ‚úÖ SCRIPT R√âSEAU SOCIAL COMPLET - VRAIS AMIS + DEMANDES + PROFIL -->
    <script type="module">
    // üîó Import Firebase
    import { db, auth } from './firebase.js';
    import { 
    collection, 
    query, 
    where, 
    orderBy, 
    limit, 
    getDocs,
    addDoc,
    doc,
    getDoc,
    updateDoc,
    serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js';

    // üîÑ CHARGER MES VRAIS AMIS (pas tous les utilisateurs)
    window.loadMyFriends = async function() {
    console.log('üîÑ Chargement MES amis Firebase...');
    
    const container = document.getElementById('friends-list-container');
    if (!container) return;
    
    container.innerHTML = `
        <div class="text-center py-8">
        <div class="text-6xl mb-4 animate-spin">üîÑ</div>
        <p class="text-gray-500 text-lg">Chargement de vos amis...</p>
        </div>
    `;
    
    try {
        const currentUserId = auth.currentUser?.uid;
        if (!currentUserId) throw new Error('Utilisateur non connect√©');
        
        // ‚úÖ R√âCUP√âRER VRAIMENT MES AMIS
        const friendshipsQuery1 = query(
        collection(db, 'friendships'),
        where('user1', '==', currentUserId)
        );
        
        const friendshipsQuery2 = query(
        collection(db, 'friendships'),
        where('user2', '==', currentUserId)
        );
        
        const [friendships1, friendships2] = await Promise.all([
        getDocs(friendshipsQuery1),
        getDocs(friendshipsQuery2)
        ]);
        
        const friendIds = [];
        friendships1.forEach(doc => {
        friendIds.push(doc.data().user2);
        });
        friendships2.forEach(doc => {
        friendIds.push(doc.data().user1);
        });
        
        if (friendIds.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
            <div class="text-6xl mb-4">üë•</div>
            <p class="text-gray-500 text-lg">Aucun ami pour le moment</p>
            <p class="text-gray-400 text-sm mt-2">Ajoutez des amis via la recherche !</p>
            <button class="ice-button mt-4 px-6 py-2 rounded-xl text-white" onclick="document.getElementById('friend-search-input').focus()">
                üîç Rechercher des amis
            </button>
            </div>
        `;
        updateFriendCounters([]);
        return;
        }
        
        // R√©cup√©rer les profils de mes amis
        const friends = [];
        for (const friendId of friendIds) {
        const friendDoc = await getDoc(doc(db, 'users', friendId));
        if (friendDoc.exists()) {
            const friendData = friendDoc.data();
            friends.push({
            id: friendId,
            ...friendData,
            isOnline: isUserOnline(friendData.lastSeen),
            points: friendData.points || 0,
            level: friendData.level || 1
            });
        }
        }
        
        // Trier par points (classement de MES amis)
        const sortedFriends = friends.sort((a, b) => (b.points || 0) - (a.points || 0));
        
        console.log('‚úÖ Mes amis charg√©s:', sortedFriends.length);
        
        displayFriendsList(sortedFriends);
        updateFriendCounters(sortedFriends);
        
    } catch (error) {
        console.error('‚ùå Erreur chargement amis:', error);
        container.innerHTML = `
        <div class="text-center py-8">
            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
            <p class="text-red-500 text-lg">Erreur de chargement</p>
            <button class="ice-button mt-4 px-6 py-2 rounded-xl text-white" onclick="loadMyFriends()">
            üîÑ R√©essayer
            </button>
        </div>
        `;
    }
    };

    // üì• CHARGER VRAIES DEMANDES D'AMIS
    window.loadFriendRequests = async function() {
    console.log('üì• Chargement demandes d\'amis...');
    
    const container = document.getElementById('friend-requests-container');
    if (!container) return;
    
    try {
        const currentUserId = auth.currentUser?.uid;
        if (!currentUserId) return;
        
        const requestsQuery = query(
        collection(db, 'friendRequests'),
        where('to', '==', currentUserId),
        where('status', '==', 'pending'),
        orderBy('createdAt', 'desc')
        );
        
        const snapshot = await getDocs(requestsQuery);
        const requests = [];
        
        for (const requestDoc of snapshot.docs) {
        const requestData = requestDoc.data();
        
        // R√©cup√©rer les infos de l'exp√©diteur
        const senderDoc = await getDoc(doc(db, 'users', requestData.from));
        if (senderDoc.exists()) {
            requests.push({
            id: requestDoc.id,
            ...requestData,
            sender: { id: requestData.from, ...senderDoc.data() }
            });
        }
        }
        
        console.log('‚úÖ Demandes charg√©es:', requests.length);
        displayFriendRequests(requests);
        
    } catch (error) {
        console.error('‚ùå Erreur demandes:', error);
        container.innerHTML = `
        <div class="text-center py-6">
            <div class="text-4xl mb-2">‚ö†Ô∏è</div>
            <p class="text-red-500">Erreur de chargement des demandes</p>
        </div>
        `;
    }
    };

    // üì§ ENVOYER VRAIE DEMANDE D'AMI
    window.sendRealFriendRequest = async function(targetUserId, targetName) {
    try {
        const currentUserId = auth.currentUser?.uid;
        if (!currentUserId) throw new Error('Non connect√©');
        
        // V√©rifier demande existante
        const existingQuery = query(
        collection(db, 'friendRequests'),
        where('from', '==', currentUserId),
        where('to', '==', targetUserId),
        where('status', 'in', ['pending', 'accepted'])
        );
        
        const existingSnapshot = await getDocs(existingQuery);
        if (!existingSnapshot.empty) {
        throw new Error('Demande d√©j√† envoy√©e');
        }
        
        // Cr√©er la demande
        await addDoc(collection(db, 'friendRequests'), {
        from: currentUserId,
        to: targetUserId,
        status: 'pending',
        message: '',
        createdAt: serverTimestamp()
        });
        
        showNotification(`‚úÖ Demande envoy√©e √† ${targetName}`, 'success');
        
        // Fermer la recherche
        const searchResults = document.getElementById('search-results');
        const searchInput = document.getElementById('friend-search-input');
        if (searchResults) searchResults.classList.add('hidden');
        if (searchInput) searchInput.value = '';
        
    } catch (error) {
        console.error('‚ùå Erreur demande:', error);
        showNotification('‚ùå ' + error.message, 'error');
    }
    };

    // ‚úÖ‚ùå R√âPONDRE √Ä UNE DEMANDE D'AMI
    window.respondToFriendRequest = async function(requestId, action) {
    try {
        const requestRef = doc(db, 'friendRequests', requestId);
        const requestSnap = await getDoc(requestRef);
        
        if (!requestSnap.exists()) {
        throw new Error('Demande introuvable');
        }
        
        const requestData = requestSnap.data();
        
        if (action === 'accept') {
        // Cr√©er l'amiti√©
        await addDoc(collection(db, 'friendships'), {
            user1: requestData.from,
            user2: requestData.to,
            createdAt: serverTimestamp(),
            lastInteraction: serverTimestamp()
        });
        
        showNotification('‚úÖ Ami ajout√© !', 'success');
        } else {
        showNotification('‚ùå Demande refus√©e', 'info');
        }
        
        // Marquer la demande comme trait√©e
        await updateDoc(requestRef, {
        status: action === 'accept' ? 'accepted' : 'declined',
        respondedAt: serverTimestamp()
        });
        
        // Recharger les donn√©es
        await Promise.all([
        loadFriendRequests(),
        loadMyFriends()
        ]);
        
    } catch (error) {
        console.error('‚ùå Erreur r√©ponse:', error);
        showNotification('‚ùå ' + error.message, 'error');
    }
    };

    // üèÜ CHARGER CLASSEMENT GLOBAL
    window.loadGlobalRanking = async function() {
    console.log('üèÜ Chargement classement global...');
    
    // Cr√©er une nouvelle section pour le classement global
    const friendsSection = document.getElementById('friends-section');
    if (!friendsSection) return;
    
    // Ajouter le bouton de classement global si pas d√©j√† l√†
    let globalButton = document.getElementById('global-ranking-btn');
    if (!globalButton) {
        const buttonsContainer = friendsSection.querySelector('.flex.items-center.justify-between');
        if (buttonsContainer) {
        const rightDiv = buttonsContainer.querySelector('.flex.items-center.space-x-3');
        if (rightDiv) {
            globalButton = document.createElement('button');
            globalButton.id = 'global-ranking-btn';
            globalButton.className = 'ice-button px-3 py-1 rounded-lg text-white text-sm';
            globalButton.innerHTML = 'üåç Global';
            globalButton.onclick = showGlobalRankingModal;
            rightDiv.appendChild(globalButton);
        }
        }
    }
    
    try {
        // R√©cup√©rer le classement global
        const globalQuery = query(
        collection(db, 'users'),
        orderBy('points', 'desc'),
        limit(50)
        );
        
        const snapshot = await getDocs(globalQuery);
        const globalRanking = [];
        
        snapshot.forEach((doc, index) => {
        const userData = doc.data();
        globalRanking.push({
            rank: index + 1,
            id: doc.id,
            ...userData,
            isOnline: isUserOnline(userData.lastSeen),
            points: userData.points || 0,
            level: userData.level || 1
        });
        });
        
        window.globalRankingData = globalRanking;
        console.log('‚úÖ Classement global charg√©:', globalRanking.length, 'utilisateurs');
        
    } catch (error) {
        console.error('‚ùå Erreur classement global:', error);
    }
    };

    // üåç MODAL CLASSEMENT GLOBAL
    window.showGlobalRankingModal = function() {
    if (!window.globalRankingData) {
        showNotification('üîÑ Chargement du classement...', 'info');
        loadGlobalRanking();
        return;
    }
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.onclick = (e) => {
        if (e.target === modal) {
        document.body.removeChild(modal);
        }
    };
    
    const currentUserId = auth.currentUser?.uid;
    const userRank = window.globalRankingData.findIndex(user => user.id === currentUserId) + 1;
    
    modal.innerHTML = `
        <div class="frost-effect rounded-2xl p-6 m-4 max-w-2xl max-h-[80vh] overflow-y-auto ice-shadow">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-800">üèÜ Classement Global CHECKICE</h2>
            <button class="ice-button-secondary rounded-xl p-2" onclick="document.body.removeChild(this.closest('.fixed'))">‚úï</button>
        </div>
        
        ${userRank > 0 ? `
            <div class="bg-blue-100 border border-blue-300 rounded-xl p-4 mb-6">
            <p class="text-blue-800 font-semibold">üéØ Votre position : #${userRank}</p>
            </div>
        ` : ''}
        
        <div class="space-y-3">
            ${window.globalRankingData.slice(0, 20).map(user => `
            <div class="flex items-center justify-between p-4 rounded-xl ${user.id === currentUserId ? 'bg-blue-50 border-2 border-blue-300' : 'bg-gray-50'} hover:bg-gray-100 transition-colors cursor-pointer" onclick="showUserProfile('${user.id}')">
                <div class="flex items-center">
                <div class="ranking-badge ${getRankBgColor(user.rank)} flex items-center justify-center text-white font-bold mr-4">
                    ${getMedal(user.rank) || user.rank}
                </div>
                <div class="w-12 h-12 rounded-xl ${getAvatarGradient(user.displayName || user.email)} flex items-center justify-center text-white font-bold mr-4">
                    ${getInitials(user.displayName || user.email)}
                </div>
                <div>
                    <h4 class="font-bold text-gray-800">${user.displayName || user.email.split('@')[0]}</h4>
                    <p class="text-sm text-gray-600">‚õ∏Ô∏è Niveau ${user.level} ${user.isOnline ? 'üü¢' : 'üî¥'}</p>
                </div>
                </div>
                <div class="text-right">
                <div class="text-lg font-bold text-blue-600">üèÜ ${user.points}</div>
                <div class="text-xs text-gray-500">points</div>
                </div>
            </div>
            `).join('')}
        </div>
        
        <div class="text-center mt-6">
            <p class="text-gray-500 text-sm">Top 20 des ${window.globalRankingData.length} utilisateurs CHECKICE</p>
        </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    };


    // üîç RECHERCHE UTILISATEURS (mise √† jour)
    window.searchFirebaseUsers = async function(searchTerm) {
    if (!searchTerm || searchTerm.length < 2) return [];
    
    try {
        const searchLower = searchTerm.toLowerCase().trim();
        const currentUserId = auth.currentUser?.uid;
        
        // Recherche par email et displayName
        const emailQuery = query(
        collection(db, 'users'),
        where('email', '>=', searchLower),
        where('email', '<=', searchLower + '\uf8ff'),
        limit(8)
        );
        
        const nameQuery = query(
        collection(db, 'users'),
        where('displayName', '>=', searchLower),
        where('displayName', '<=', searchLower + '\uf8ff'), 
        limit(8)
        );
        
        const [emailSnapshot, nameSnapshot] = await Promise.all([
        getDocs(emailQuery),
        getDocs(nameQuery)
        ]);
        
        const users = new Map();
        
        [...emailSnapshot.docs, ...nameSnapshot.docs].forEach(docSnap => {
        const userData = docSnap.data();
        if (userData.email !== auth.currentUser?.email && !users.has(docSnap.id)) {
            users.set(docSnap.id, { 
            id: docSnap.id,
            ...userData 
            });
        }
        });
        
        return Array.from(users.values()).slice(0, 8);
        
    } catch (error) {
        console.error('‚ùå Erreur recherche:', error);
        return [];
    }
    };

    // üîÑ Fonction d'actualisation mise √† jour
    window.refreshFriends = async function() {
    console.log('üîÑ Actualisation compl√®te...');
    await Promise.all([
        loadMyFriends(),
        loadFriendRequests(),
        loadGlobalRanking()
    ]);
    showNotification('‚úÖ Tout actualis√© !', 'success');
    };

    // üöÄ INITIALISATION
    document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initialisation r√©seau social complet...');
    
    // Configuration recherche (code identique au pr√©c√©dent)
    const searchInput = document.getElementById('friend-search-input');
    const searchResults = document.getElementById('search-results');
    
    if (searchInput && searchResults) {
        let searchTimeout;
        
        searchInput.addEventListener('input', async (e) => {
        const searchTerm = e.target.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (searchTerm.length < 2) {
            searchResults.classList.add('hidden');
            return;
        }
        
        searchTimeout = setTimeout(async () => {
            searchResults.innerHTML = `
            <div class="p-4">
                <div class="flex items-center justify-center py-4">
                <div class="animate-spin text-2xl mr-2">üîÑ</div>
                <span class="text-gray-600">Recherche...</span>
                </div>
            </div>
            `;
            searchResults.classList.remove('hidden');
            
            try {
            const users = await searchFirebaseUsers(searchTerm);
            displaySearchResults(users, searchTerm);
            } catch (error) {
            console.error('‚ùå Erreur recherche:', error);
            }
        }, 500);
        });
        
        document.addEventListener('click', (e) => {
        if (!e.target.closest('.friends-search-container')) {
            searchResults.classList.add('hidden');
        }
        });
    }
    
    // ‚úÖ CHARGEMENT AUTOMATIQUE
    setTimeout(() => {
        console.log('üîÑ Chargement automatique...');
        loadMyFriends();
        loadFriendRequests();
        loadGlobalRanking();
    }, 2000);
    
    updateFriendCounters([]);
    });

    // üõ†Ô∏è FONCTIONS UTILITAIRES
    function displayFriendRequests(requests) {
    const container = document.getElementById('friend-requests-container');
    const countBadge = document.getElementById('requests-count');
    
    if (countBadge) {
        if (requests.length > 0) {
        countBadge.textContent = requests.length;
        countBadge.classList.remove('hidden');
        } else {
        countBadge.classList.add('hidden');
        }
    }
    
    if (!container) return;
    
    if (requests.length === 0) {
        container.innerHTML = `
        <div class="text-center py-6">
            <div class="text-4xl mb-2">üì≠</div>
            <p class="text-gray-500 italic">Aucune demande en attente</p>
        </div>
        `;
        return;
    }
    
    container.innerHTML = requests.map(request => {
        const timeAgo = getTimeAgo(request.createdAt.toDate ? request.createdAt.toDate() : request.createdAt);
        
        return `
        <div class="glass-effect rounded-xl p-4 mb-4 border border-blue-100">
            <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-14 h-14 rounded-2xl ${getAvatarGradient(request.sender.displayName || request.sender.email)} flex items-center justify-center text-white font-bold text-lg mr-4">
                ${getInitials(request.sender.displayName || request.sender.email)}
                </div>
                <div class="flex-1">
                <h4 class="font-bold text-gray-800">
                    ${request.sender.displayName || request.sender.email.split('@')[0]}
                </h4>
                <p class="text-sm text-gray-600">üìß ${request.sender.email}</p>
                <p class="text-xs text-gray-400">${timeAgo}</p>
                </div>
            </div>
            <div class="flex space-x-2 ml-4">
                <button 
                class="ice-button py-2 px-4 rounded-lg text-white font-semibold text-sm"
                onclick="respondToFriendRequest('${request.id}', 'accept')"
                >
                ‚úÖ Accepter
                </button>
                <button 
                class="ice-button-secondary py-2 px-4 rounded-lg font-semibold text-sm"
                onclick="respondToFriendRequest('${request.id}', 'decline')"
                >
                ‚ùå Refuser
                </button>
            </div>
            </div>
        </div>
        `;
    }).join('');
    }

        function displaySearchResults(users, searchTerm) {
    const searchResults = document.getElementById('search-results');
    if (!searchResults) return;
    
    if (users.length === 0) {
        searchResults.innerHTML = `
        <div class="p-4">
            <h4 class="font-bold text-gray-800 mb-3">üîç "${searchTerm}"</h4>
            <div class="text-center py-4">
            <div class="text-4xl mb-2">ü§∑‚Äç‚ôÇÔ∏è</div>
            <p class="text-gray-500">Aucun utilisateur trouv√©</p>
            </div>
        </div>
        `;
        searchResults.classList.remove('hidden');
        return;
    }
    
    searchResults.innerHTML = `
        <div class="p-4">
        <h4 class="font-bold text-gray-800 mb-3">üîç ${users.length} r√©sultat(s)</h4>
        <div class="space-y-3">
            ${users.map(user => `
            <div class="flex items-center justify-between p-3 rounded-xl hover:bg-gray-50 transition-colors">
                <!-- ‚úÖ CLIC AVEC FERMETURE AUTOMATIQUE -->
                <div class="flex items-center cursor-pointer flex-1" onclick="showUserProfile('${user.id}')">
                <div class="w-12 h-12 rounded-xl ${getAvatarGradient(user.displayName || user.email)} flex items-center justify-center text-white font-bold mr-4">
                    ${getInitials(user.displayName || user.email)}
                </div>
                <div>
                    <h5 class="font-bold text-gray-800">${user.displayName || user.email.split('@')[0]}</h5>
                    <p class="text-sm text-gray-600">üìß ${user.email}</p>
                    <p class="text-xs text-blue-600">üèÜ ${user.points || 0} pts ‚Ä¢ ‚õ∏Ô∏è Niveau ${user.level || 1}</p>
                </div>
                </div>
                <button 
                class="ice-button py-2 px-4 rounded-lg text-white font-semibold text-sm ml-3"
                onclick="sendRealFriendRequest('${user.id}', '${user.displayName || user.email}')"
                >
                ‚ûï Ajouter
                </button>
            </div>
            `).join('')}
        </div>
        </div>
    `;
    
    searchResults.classList.remove('hidden');
    }


    function isUserOnline(lastSeen) {
    if (!lastSeen) return false;
    
    const now = new Date();
    const lastSeenDate = lastSeen.toDate ? lastSeen.toDate() : new Date(lastSeen);
    const diffMinutes = (now - lastSeenDate) / (1000 * 60);
    
    return diffMinutes < 5;
    }

    function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMinutes = Math.floor(diffMs / 60000);
    
    if (diffMinutes < 1) return '√Ä l\'instant';
    if (diffMinutes < 60) return `Il y a ${diffMinutes}min`;
    if (diffMinutes < 1440) return `Il y a ${Math.floor(diffMinutes / 60)}h`;
    return `Il y a ${Math.floor(diffMinutes / 1440)}j`;
    }

    </script>

    <!-- ‚úÖ SCRIPT UTILITAIRES (identique au pr√©c√©dent mais avec MES amis) -->
    <script>
    function displayFriendsList(friends) {
    const container = document.getElementById('friends-list-container');
    if (!container) return;
    
    if (friends.length === 0) {
        container.innerHTML = `
        <div class="text-center py-8">
            <div class="text-6xl mb-4">üë•</div>
            <p class="text-gray-500 text-lg">Aucun ami pour le moment</p>
            <p class="text-gray-400 text-sm mt-2">Ajoutez des amis via la recherche !</p>
            <button class="ice-button mt-4 px-6 py-2 rounded-xl text-white" onclick="document.getElementById('friend-search-input').focus()">
            üîç Rechercher des amis
            </button>
        </div>
        `;
        return;
    }
    
    container.innerHTML = friends.map((friend, index) => {
        const rank = index + 1;
        const medal = getMedal(rank);
        const lastSeenText = getLastSeenText(friend.lastSeen, friend.isOnline);
        const initials = getInitials(friend.displayName || friend.email);
        const avatarColor = getAvatarGradient(friend.displayName || friend.email);
        
        return `
        <div class="friend-ranking-item glass-effect rounded-xl p-4 mb-4 ${rank <= 3 ? 'border-2 ' + getRankBorderColor(rank) : ''}">
            <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="ranking-badge ${getRankBgColor(rank)} flex items-center justify-center text-white font-bold mr-4">
                ${medal || rank}
                </div>
                
                <div class="relative">
                <div class="w-14 h-14 rounded-2xl ${avatarColor} flex items-center justify-center text-white font-bold text-lg">
                    ${initials}
                </div>
                <div class="absolute -bottom-1 -right-1 w-4 h-4 rounded-full border-2 border-white ${friend.isOnline ? 'bg-green-400' : 'bg-gray-400'}"></div>
                </div>
                
                <div class="ml-4 flex-1 cursor-pointer" onclick="showUserProfile('${friend.id}')">
                <h4 class="font-bold text-gray-800 hover:text-blue-600 transition-colors">
                    ${friend.displayName || friend.email.split('@')[0]}
                </h4>
                <p class="text-sm text-gray-600 mb-1">üìß ${friend.email}</p>
                <div class="flex items-center space-x-3">
                    <span class="text-sm bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-semibold">
                    üèÜ ${friend.points || 0} pts
                    </span>
                    <span class="text-sm text-gray-600">
                    ‚õ∏Ô∏è Niveau ${friend.level || 1}
                    </span>
                </div>
                <p class="text-xs text-gray-400 mt-1">${lastSeenText}</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-2">
                <button 
                class="action-btn ice-button-secondary rounded-xl p-2 hover:scale-105 transition-transform"
                onclick="showUserProfile('${friend.id}')"
                title="Voir le profil"
                >
                üë§
                </button>
                <button 
                class="action-btn ice-button rounded-xl p-2 text-white hover:scale-105 transition-transform"
                title="Message"
                >
                üí¨
                </button>
            </div>
            </div>
        </div>
        `;
    }).join('');
    }

    function updateFriendCounters(friends = []) {
    const friendCountEl = document.getElementById('friend-count');
    const onlineCountEl = document.getElementById('online-count');
    
    if (friendCountEl) {
        friendCountEl.textContent = `${friends.length} ami${friends.length > 1 ? 's' : ''}`;
    }
    
    if (onlineCountEl) {
        const onlineCount = friends.filter(friend => friend.isOnline).length;
        onlineCountEl.textContent = `${onlineCount} en ligne`;
        onlineCountEl.className = onlineCount > 0 ? 
        'bg-green-100 text-green-600 text-sm font-bold px-3 py-1 rounded-full' :
        'bg-gray-100 text-gray-600 text-sm font-bold px-3 py-1 rounded-full';
    }
    }

    // Fonctions utilitaires identiques au script pr√©c√©dent
    function getInitials(name) {
    if (!name) return '?';
    return name.split(' ').map(word => word.charAt(0).toUpperCase()).join('').substring(0, 2);
    }

    function getAvatarGradient(name) {
    const gradients = [
        'bg-gradient-to-r from-purple-500 to-blue-500',
        'bg-gradient-to-r from-green-500 to-teal-400', 
        'bg-gradient-to-r from-red-500 to-pink-400',
        'bg-gradient-to-r from-yellow-500 to-orange-400',
        'bg-gradient-to-r from-indigo-500 to-purple-500',
        'bg-gradient-to-r from-pink-500 to-rose-400'
    ];
    const hash = (name || '').split('').reduce((a, b) => {
        a = ((a << 5) - a) + b.charCodeAt(0);
        return a & a;
    }, 0);
    return gradients[Math.abs(hash) % gradients.length];
    }

    function getMedal(rank) {
    const medals = { 1: 'ü•á', 2: 'ü•à', 3: 'ü•â' };
    return medals[rank] || null;
    }

    function getRankBgColor(rank) {
    const colors = {
        1: 'w-10 h-10 rounded-full bg-gradient-to-r from-yellow-400 to-orange-400',
        2: 'w-10 h-10 rounded-full bg-gradient-to-r from-gray-400 to-gray-500',
        3: 'w-10 h-10 rounded-full bg-gradient-to-r from-amber-600 to-yellow-500'
    };
    return colors[rank] || 'w-10 h-10 rounded-full bg-gradient-to-r from-blue-400 to-blue-500';
    }

    function getRankBorderColor(rank) {
    const colors = {
        1: 'border-yellow-400',
        2: 'border-gray-400', 
        3: 'border-amber-500'
    };
    return colors[rank] || 'border-blue-400';
    }

    function getLastSeenText(lastSeen, isOnline) {
    if (isOnline) return 'üü¢ En ligne';
    if (!lastSeen) return 'üî¥ Jamais connect√©';
    
    const now = new Date();
    const lastSeenDate = lastSeen.toDate ? lastSeen.toDate() : new Date(lastSeen);
    const diffMs = now - lastSeenDate;
    const diffMinutes = Math.floor(diffMs / 60000);
    
    if (diffMinutes < 60) return `üü° Il y a ${diffMinutes}min`;
    if (diffMinutes < 1440) return `üü† Il y a ${Math.floor(diffMinutes / 60)}h`;
    return `üî¥ Il y a ${Math.floor(diffMinutes / 1440)}j`;
    }

    function showNotification(message, type = 'info') {
    console.log('üîî', message);
    
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-xl text-white font-semibold z-50 transform transition-all duration-300 ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
    }`;
    notification.textContent = message;
    notification.style.transform = 'translateX(100%)';
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
        if (document.body.contains(notification)) {
            document.body.removeChild(notification);
        }
        }, 300);
    }, 3000);
    }
    </script>





</body>
</html>
