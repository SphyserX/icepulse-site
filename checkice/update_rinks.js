// ============================================================================
// update-rinks.js - GESTION PATINOIRES CHECKICE
// ============================================================================
// 
// Ce script permet de :
// ‚úÖ MODIFIER des patinoires existantes (ID pr√©serv√©s)
// ‚úÖ AJOUTER de nouvelles patinoires (nouveaux ID auto-g√©n√©r√©s)
//
// Structure de donn√©es bas√©e sur la collection 'rinks' de CheckICE :
// - name: Nom de la patinoire (string)
// - city: Ville (string)
// - adresse: Adresse compl√®te (string)
// - coordinates: [latitude, longitude] (array de 2 numbers)
// - status: "open" | "closed" | "renovation" (string)
// - phone: Num√©ro de t√©l√©phone (string)
// - horaires: Horaires d'ouverture (string, format libre)
// - tarifs: Tarifs d'entr√©e (string, format libre)
// - website: URL du site web (string)
// - createdAt: Date de cr√©ation (Timestamp Firebase, ajout√© automatiquement)
// - updatedAt: Date de modification (Timestamp Firebase, ajout√© automatiquement)
//
// ============================================================================

import { db } from './firebase.js';
import { collection, addDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

// ============================================================================
// SECTION 1 : PATINOIRES EXISTANTES √Ä MODIFIER
// ============================================================================
// 
// Pour modifier une patinoire existante :
// - L'ID Firebase DOIT √™tre fourni (ne sera jamais modifi√©)
// - Seuls les champs fournis seront mis √† jour (merge: true)
// - Les relations avec reviews, visitedRinks, etc. restent intactes
//
// Structure d'un objet :
// {
//     id: "ID_FIREBASE_EXISTANT",
//     data: {
//         name: "Nom de la patinoire",
//         city: "Ville",
//         adresse: "Adresse compl√®te",
//         coordinates: [latitude, longitude],
//         status: "open" | "closed" | "renovation",
//         phone: "Num√©ro",
//         horaires: "Horaires",
//         tarifs: "Tarifs",
//         website: "URL"
//     }
// }
//
// ‚ö†Ô∏è IMPORTANT : Tu peux modifier UN ou PLUSIEURS champs, pas besoin de tous les mettre

const existingRinksToUpdate = [
    // EXEMPLE 1 : Modification compl√®te
    {
        id: "5R3QmDcz1yIYhsGjutyA",
        data: {
            name: "Ice Club Montpellier",
            city: "Montpellier",
            adresse: "Avenue de Heidelberg, 34000 Montpellier",
            coordinates: [43.611, 3.8767],
            status: "open",
            phone: "04 67 11 22 33",
            horaires: "Mar-Dim: 14h-21h, Ferm√© lundi (sauf vacances)",
            tarifs: "Adulte: 8‚Ç¨, Enfant: 5‚Ç¨, Groupe scolaire: 4‚Ç¨, Soir√©e: 10‚Ç¨",
            website: "https://www.ice-club-montpellier.fr"
        }
    },
    
    // EXEMPLE 2 : Modification partielle (seulement certains champs)
    {
        id: "zsrr0vG7DThqKb50aSPr",
        data: {
            status: "closed",
            horaires: "Ferm√©e pour r√©novation - R√©ouverture pr√©vue mars 2026",
            tarifs: "Ferm√©e temporairement"
        }
    }
    
    // üìå AJOUTE ICI LES AUTRES PATINOIRES √Ä MODIFIER
    // Copie la structure ci-dessus et remplace les valeurs
];

// ============================================================================
// SECTION 2 : NOUVELLES PATINOIRES √Ä AJOUTER
// ============================================================================
//
// Pour ajouter une nouvelle patinoire :
// - PAS d'ID √† fournir (sera g√©n√©r√© automatiquement par Firebase)
// - TOUS les champs sont OBLIGATOIRES sauf createdAt (ajout√© automatiquement)
// - Un nouvel ID unique sera cr√©√© et retourn√©
//
// Structure d'un objet :
// {
//     name: "Nom de la patinoire",
//     city: "Ville",
//     adresse: "Adresse compl√®te",
//     coordinates: [latitude, longitude],
//     status: "open" | "closed" | "renovation",
//     phone: "Num√©ro",
//     horaires: "Horaires",
//     tarifs: "Tarifs",
//     website: "URL"
// }
//
// ‚ö†Ô∏è IMPORTANT : Tous les champs doivent √™tre remplis pour les nouvelles patinoires

const newRinksToAdd = [
    // EXEMPLE 1 : Nouvelle patinoire compl√®te
    {
        name: "Patinoire du Z√©nith",
        city: "Rennes",
        adresse: "12 Rue du Sport, 35000 Rennes",
        coordinates: [48.1119, -1.6743],
        status: "open",
        phone: "02 99 12 34 56",
        horaires: "Lun-Ven: 14h-22h, Sam-Dim: 10h-23h",
        tarifs: "Adulte: 7.5‚Ç¨, Enfant: 5‚Ç¨, √âtudiant: 6‚Ç¨",
        website: "https://www.patinoire-rennes-zenith.fr"
    },
    
    // EXEMPLE 2 : Autre nouvelle patinoire
    {
        name: "Ice Arena Dijon",
        city: "Dijon",
        adresse: "45 Boulevard de Chicago, 21000 Dijon",
        coordinates: [47.3220, 5.0415],
        status: "open",
        phone: "03 80 45 67 89",
        horaires: "Mar-Dim: 14h-21h30, Ferm√© lundi",
        tarifs: "Adulte: 8‚Ç¨, Enfant: 4.5‚Ç¨, Senior: 6‚Ç¨, Famille: 25‚Ç¨",
        website: "https://www.ice-arena-dijon.fr"
    }
    
    // üìå AJOUTE ICI LES AUTRES NOUVELLES PATINOIRES
    // Copie la structure ci-dessus et remplace les valeurs
];

// ============================================================================
// SECTION 3 : FONCTIONS FIREBASE
// ============================================================================

/**
 * Modifie une patinoire existante dans Firestore
 * @param {string} rinkId - L'ID Firebase de la patinoire (ne sera jamais modifi√©)
 * @param {Object} updates - Les champs √† mettre √† jour
 * @returns {Promise<void>}
 */
async function updateExistingRink(rinkId, updates) {
    await setDoc(doc(db, 'rinks', rinkId), {
        ...updates,
        updatedAt: new Date() // Timestamp de modification
    }, { 
        merge: true // Ne modifie que les champs fournis, garde le reste
    });
}

/**
 * Ajoute une nouvelle patinoire dans Firestore
 * @param {Object} rinkData - Les donn√©es compl√®tes de la nouvelle patinoire
 * @returns {Promise<string>} - L'ID Firebase auto-g√©n√©r√© de la nouvelle patinoire
 */
async function addNewRink(rinkData) {
    const docRef = await addDoc(collection(db, 'rinks'), {
        ...rinkData,
        createdAt: new Date() // Timestamp de cr√©ation
    });
    return docRef.id; // Retourne le nouvel ID g√©n√©r√©
}

// ============================================================================
// SECTION 4 : TRAITEMENT PRINCIPAL
// ============================================================================

/**
 * Traite toutes les modifications et ajouts de patinoires
 * @returns {Promise<Object>} - R√©sultats de l'op√©ration (succ√®s, erreurs)
 */
async function processAllRinks() {
    console.log('üöÄ D√âBUT - Traitement des patinoires CheckICE\n');
    console.log('=' .repeat(60));
    
    const results = {
        updated: [],  // Patinoires modifi√©es
        added: [],    // Patinoires ajout√©es
        errors: []    // Erreurs rencontr√©es
    };
    
    // ========== √âTAPE 1 : MODIFICATIONS ==========
    if (existingRinksToUpdate.length > 0) {
        console.log(`\nüîß MODIFICATIONS : ${existingRinksToUpdate.length} patinoires\n`);
        
        for (const rink of existingRinksToUpdate) {
            try {
                const rinkName = rink.data.name || `ID: ${rink.id}`;
                console.log(`  üîÑ Modification : ${rinkName}`);
                console.log(`     ID pr√©serv√© : ${rink.id}`);
                
                // Appel Firebase pour modifier
                await updateExistingRink(rink.id, rink.data);
                
                console.log(`  ‚úÖ Succ√®s\n`);
                results.updated.push({
                    id: rink.id,
                    name: rinkName
                });
                
                // Anti rate-limit Firebase (300ms entre chaque op√©ration)
                await new Promise(resolve => setTimeout(resolve, 300));
                
            } catch (error) {
                console.error(`  ‚ùå Erreur : ${error.message}\n`);
                results.errors.push({
                    id: rink.id,
                    type: 'modification',
                    error: error.message
                });
            }
        }
    } else {
        console.log('\n‚ö†Ô∏è Aucune modification √† effectuer\n');
    }
    
    // ========== √âTAPE 2 : AJOUTS ==========
    if (newRinksToAdd.length > 0) {
        console.log(`\nüìç AJOUTS : ${newRinksToAdd.length} nouvelles patinoires\n`);
        
        for (const rink of newRinksToAdd) {
            try {
                console.log(`  üîÑ Ajout : ${rink.name} (${rink.city})`);
                
                // Appel Firebase pour ajouter
                const newId = await addNewRink(rink);
                
                console.log(`  ‚úÖ Succ√®s - Nouvel ID : ${newId}\n`);
                results.added.push({
                    id: newId,
                    name: rink.name,
                    city: rink.city
                });
                
                // Anti rate-limit Firebase (300ms entre chaque op√©ration)
                await new Promise(resolve => setTimeout(resolve, 300));
                
            } catch (error) {
                console.error(`  ‚ùå Erreur : ${error.message}\n`);
                results.errors.push({
                    name: rink.name,
                    type: 'ajout',
                    error: error.message
                });
            }
        }
    } else {
        console.log('\n‚ö†Ô∏è Aucun ajout √† effectuer\n');
    }
    
    // ========== √âTAPE 3 : R√âSUM√â ==========
    console.log('\n' + '='.repeat(60));
    console.log('üéâ FIN DU TRAITEMENT');
    console.log('='.repeat(60));
    console.log(`\nüìä R√âSULTATS :`);
    console.log(`   üîß ${results.updated.length} patinoires modifi√©es (ID pr√©serv√©s)`);
    console.log(`   üìç ${results.added.length} patinoires ajout√©es (nouveaux ID)`);
    console.log(`   ‚ùå ${results.errors.length} erreurs`);
    
    // Afficher les d√©tails des modifications
    if (results.updated.length > 0) {
        console.log(`\n‚úÖ PATINOIRES MODIFI√âES :`);
        results.updated.forEach(r => {
            console.log(`   ‚Ä¢ ${r.name} [ID: ${r.id}]`);
        });
    }
    
    // Afficher les d√©tails des ajouts
    if (results.added.length > 0) {
        console.log(`\n‚úÖ PATINOIRES AJOUT√âES :`);
        results.added.forEach(r => {
            console.log(`   ‚Ä¢ ${r.name} (${r.city}) [Nouveau ID: ${r.id}]`);
        });
    }
    
    // Afficher les erreurs
    if (results.errors.length > 0) {
        console.log(`\n‚ö†Ô∏è ERREURS :`);
        results.errors.forEach(e => {
            console.log(`   ‚Ä¢ ${e.name || e.id} (${e.type}) : ${e.error}`);
        });
    }
    
    console.log('\n' + '='.repeat(60));
    
    return results;
}

// ============================================================================
// SECTION 5 : INTERFACE UTILISATEUR (BOUTON)
// ============================================================================

document.addEventListener('DOMContentLoaded', () => {
    // Cr√©er le bouton d'action
    const button = document.createElement('button');
    button.textContent = 'üöÄ Mettre √† jour les patinoires';
    button.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        padding: 16px 32px;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        font-family: 'Inter', -apple-system, sans-serif;
        transition: all 0.3s ease;
    `;
    
    // Animation hover
    button.addEventListener('mouseenter', () => {
        button.style.transform = 'translateY(-2px)';
        button.style.boxShadow = '0 12px 28px rgba(99, 102, 241, 0.5)';
    });
    
    button.addEventListener('mouseleave', () => {
        button.style.transform = 'translateY(0)';
        button.style.boxShadow = '0 8px 20px rgba(99, 102, 241, 0.4)';
    });
    
    // Action au clic
    button.addEventListener('click', async () => {
        // Confirmation avant ex√©cution
        const totalOperations = existingRinksToUpdate.length + newRinksToAdd.length;
        const confirmMessage = 
            `‚ö†Ô∏è CONFIRMATION\n\n` +
            `Op√©rations pr√©vues :\n` +
            `üîß ${existingRinksToUpdate.length} modifications (ID pr√©serv√©s)\n` +
            `üìç ${newRinksToAdd.length} ajouts (nouveaux ID)\n\n` +
            `Total : ${totalOperations} patinoires\n\n` +
            `Continuer ?`;
        
        if (!confirm(confirmMessage)) {
            console.log('‚ùå Op√©ration annul√©e par l\'utilisateur');
            return;
        }
        
        // D√©sactiver le bouton pendant le traitement
        button.disabled = true;
        button.textContent = '‚è≥ Traitement en cours...';
        button.style.background = 'linear-gradient(135deg, #6b7280, #9ca3af)';
        button.style.cursor = 'not-allowed';
        
        try {
            // Lancer le traitement
            const results = await processAllRinks();
            
            // Message de succ√®s
            const successMessage = 
                `‚úÖ Op√©ration termin√©e !\n\n` +
                `üîß ${results.updated.length} modifications\n` +
                `üìç ${results.added.length} ajouts\n` +
                `‚ùå ${results.errors.length} erreurs\n\n` +
                `Consulte la console pour les d√©tails.`;
            
            alert(successMessage);
            
            showNotification(successMessage, 'success');

            // Proposer de recharger avec modale personnalis√©e
            setTimeout(async () => {
            const reload = await showCustomConfirm(
                'Recharger la page ?',
                'Les modifications seront visibles apr√®s rechargement.'
            );
            if (reload) location.reload();
            }, 1500);

            
        } catch (error) {
            // Gestion des erreurs critiques
            console.error('‚ùå ERREUR CRITIQUE :', error);
            alert(`‚ùå Erreur critique :\n${error.message}`);
            
            // R√©activer le bouton
            button.disabled = false;
            button.textContent = 'üîÑ R√©essayer';
            button.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
            button.style.cursor = 'pointer';
        }
    });
    
    // Ajouter le bouton √† la page
    document.body.appendChild(button);
    
    // Log de chargement
    console.log('üîß Script CheckICE charg√© et pr√™t');
    console.log(`üìä Donn√©es d√©tect√©es :`);
    console.log(`   ‚Ä¢ ${existingRinksToUpdate.length} patinoires √† modifier`);
    console.log(`   ‚Ä¢ ${newRinksToAdd.length} patinoires √† ajouter`);
});

// ============================================================================
// EXPORTS (pour usage externe si besoin)
// ============================================================================

export { 
    updateExistingRink, 
    addNewRink, 
    processAllRinks 
};
